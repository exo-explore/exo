var Ve=Object.defineProperty;var Se=s=>{throw TypeError(s)};var Ke=(s,e,t)=>e in s?Ve(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var ce=(s,e,t)=>Ke(s,typeof e!="symbol"?e+"":e,t),Ye=(s,e,t)=>e.has(s)||Se("Cannot "+t);var g=(s,e,t)=>(Ye(s,e,"read from private field"),t?t.call(s):e.get(s)),T=(s,e,t)=>e.has(s)?Se("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t);import{h as R,L as qe,K as Ge,v as x,W as Xe,N as Qe,O as Ze,P as Ae,Q as ve,R as me,g as he,a5 as et,aE as tt,an as ke,c as st,f as Ce,s as nt,aC as Ue,aJ as it,b as we,aH as at,af as Pe,aK as Be,aL as Fe,aM as rt,a4 as ot,aN as je,a as He,p as lt,aO as ye,q as ze,aP as dt,a6 as ct,aQ as ht,aR as ft,aB as ut,d as gt,aS as pt,aT as vt,aU as mt,aV as yt,aW as It,o as _,t as H,x as b,n as Mt,y as De,z as Ct,A as wt,B as xt,ao as Tt,C as Ee}from"./Cs2YbYqB.js";import{f as We,a as Ne}from"./cZOEMoTm.js";import{i as _t}from"./DtOJveqb.js";import{d as bt}from"./X9orTM-q.js";import{p as Oe,i as St}from"./BMwDbPWL.js";function Gt(s,e){return e}function At(s,e,t){for(var n=[],i=e.length,l=0;l<i;l++)ht(e[l].e,n,!0);ft(n,()=>{var a=n.length===0&&t!==null;if(a){var h=t,o=h.parentNode;ut(o),o.append(h),s.items.clear(),U(s,e[0].prev,e[i-1].next)}for(var M=0;M<i;M++){var d=e[M];a||(s.items.delete(d.k),U(s,d.prev,d.next)),gt(d.e,!a)}s.first===e[0]&&(s.first=e[0].prev)})}function Xt(s,e,t,n,i,l=null){var a=s,h=new Map,o=null,M=(e&je)!==0,d=(e&Fe)!==0,v=(e&Be)!==0;if(M){var C=s;a=R?ve(ot(C)):C.appendChild(we())}R&&qe();var r=null,S=Xe(()=>{var f=t();return it(f)?f:f==null?[]:Ue(f)}),m,c=!0;function u(){kt(y,m,a,e,n),r!==null&&(m.length===0?(r.fragment?(a.before(r.fragment),r.fragment=null):He(r.effect),D.first=r.effect):lt(r.effect,()=>{r=null}))}var D=Ge(()=>{m=x(S);var f=m.length;let w=!1;if(R){var E=Qe(a)===Ze;E!==(f===0)&&(a=Ae(),ve(a),me(!1),w=!0)}for(var F=new Set,N=st,P=null,B=nt(),L=0;L<f;L+=1){R&&he.nodeType===et&&he.data===tt&&(a=he,w=!0,me(!1));var j=m[L],O=n(j,L),p=c?null:h.get(O);p?(d&&ke(p.v,j),v?ke(p.i,L):p.i=L,B&&N.skipped_effects.delete(p.e)):(p=Pt(c?a:null,P,j,O,L,i,e,t),c&&(p.o=!0,P===null?o=p:P.next=p,P=p),h.set(O,p)),F.add(O)}if(f===0&&l&&!r)if(c)r={fragment:null,effect:Ce(()=>l(a))};else{var A=document.createDocumentFragment(),k=we();A.append(k),r={fragment:A,effect:Ce(()=>l(k))}}if(R&&f>0&&ve(Ae()),!c)if(B){for(const[ue,z]of h)F.has(ue)||N.skipped_effects.add(z.e);N.oncommit(u),N.ondiscard(()=>{})}else u();w&&me(!0),x(S)}),y={effect:D,items:h,first:o};c=!1,R&&(a=he)}function kt(s,e,t,n,i){var L,j,O,p;var l=(n&dt)!==0,a=e.length,h=s.items,o=s.first,M,d=null,v,C=[],r=[],S,m,c,u;if(l)for(u=0;u<a;u+=1)S=e[u],m=i(S,u),c=h.get(m),c.o&&((L=c.a)==null||L.measure(),(v??(v=new Set)).add(c));for(u=0;u<a;u+=1){if(S=e[u],m=i(S,u),c=h.get(m),s.first??(s.first=c),!c.o){c.o=!0;var D=d?d.next:o;U(s,d,c),U(s,c,D),Ie(c,D,t),d=c,C=[],r=[],o=d.next;continue}if((c.e.f&ye)!==0&&(He(c.e),l&&((j=c.a)==null||j.unfix(),(v??(v=new Set)).delete(c))),c!==o){if(M!==void 0&&M.has(c)){if(C.length<r.length){var y=r[0],f;d=y.prev;var w=C[0],E=C[C.length-1];for(f=0;f<C.length;f+=1)Ie(C[f],y,t);for(f=0;f<r.length;f+=1)M.delete(r[f]);U(s,w.prev,E.next),U(s,d,w),U(s,E,y),o=y,d=E,u-=1,C=[],r=[]}else M.delete(c),Ie(c,o,t),U(s,c.prev,c.next),U(s,c,d===null?s.first:d.next),U(s,d,c),d=c;continue}for(C=[],r=[];o!==null&&o.k!==m;)(o.e.f&ye)===0&&(M??(M=new Set)).add(o),r.push(o),o=o.next;if(o===null)continue;c=o}C.push(c),d=c,o=c.next}let F=h.size>a;if(o!==null||M!==void 0){for(var N=M===void 0?[]:Ue(M);o!==null;)(o.e.f&ye)===0&&N.push(o),o=o.next;var P=N.length;if(F=h.size-P>a,P>0){var B=(n&je)!==0&&a===0?t:null;if(l){for(u=0;u<P;u+=1)(O=N[u].a)==null||O.measure();for(u=0;u<P;u+=1)(p=N[u].a)==null||p.fix()}At(s,N,B)}}if(F)for(const A of h.values())A.o||(U(s,d,A),d=A);s.effect.last=d&&d.e,l&&ze(()=>{var A;if(v!==void 0)for(c of v)(A=c.a)==null||A.apply()})}function Pt(s,e,t,n,i,l,a,h){var o=(a&Fe)!==0,M=(a&rt)===0,d=o?M?at(t,!1,!1):Pe(t):t,v=(a&Be)===0?i:Pe(i),C={i:v,v:d,k:n,a:null,e:null,o:!1,prev:e,next:null};try{if(s===null){var r=document.createDocumentFragment();r.append(s=we())}return C.e=Ce(()=>l(s,d,v,h)),e!==null&&(e.next=C),C}finally{}}function Ie(s,e,t){for(var n=s.next?s.next.e.nodes_start:t,i=e?e.e.nodes_start:t,l=s.e.nodes_start;l!==null&&l!==n;){var a=ct(l);i.before(l),l=a}}function U(s,e,t){e===null?(s.first=t,s.effect.first=t&&t.e):(e.e.next&&(e.e.next.prev=null),e.next=t,e.e.next=t&&t.e),t!==null&&(t.e.prev&&(t.e.prev.next=null),t.prev=e,t.e.prev=e&&e.e)}function $e(s){var e,t,n="";if(typeof s=="string"||typeof s=="number")n+=s;else if(typeof s=="object")if(Array.isArray(s)){var i=s.length;for(e=0;e<i;e++)s[e]&&(t=$e(s[e]))&&(n&&(n+=" "),n+=t)}else for(t in s)s[t]&&(n&&(n+=" "),n+=t);return n}function Dt(){for(var s,e,t=0,n="",i=arguments.length;t<i;t++)(s=arguments[t])&&(e=$e(s))&&(n&&(n+=" "),n+=e);return n}function Qt(s){return typeof s=="object"?Dt(s):s??""}function Et(s,e,t){var n=s==null?"":""+s;return e&&(n=n?n+" "+e:e),n===""?null:n}function Nt(s,e){return s==null?null:String(s)}function Ot(s,e,t,n,i,l){var a=s.__className;if(R||a!==t||a===void 0){var h=Et(t,n);(!R||h!==s.getAttribute("class"))&&(h==null?s.removeAttribute("class"):e?s.className=h:s.setAttribute("class",h)),s.__className=t}return l}function Zt(s,e,t,n){var i=s.__style;if(R||i!==e){var l=Nt(e);(!R||l!==s.getAttribute("style"))&&(l==null?s.removeAttribute("style"):s.style.cssText=l),s.__style=e}return n}const Lt=Symbol("is custom element"),Rt=Symbol("is html");function es(s){if(R){var e=!1,t=()=>{if(!e){if(e=!0,s.hasAttribute("value")){var n=s.value;xe(s,"value",null),s.value=n}if(s.hasAttribute("checked")){var i=s.checked;xe(s,"checked",null),s.checked=i}}};s.__on_r=t,ze(t),pt()}}function xe(s,e,t,n){var i=Ut(s);R&&(i[e]=s.getAttribute(e),e==="src"||e==="srcset"||e==="href"&&s.nodeName==="LINK")||i[e]!==(i[e]=t)&&(e==="loading"&&(s[vt]=t),t==null?s.removeAttribute(e):typeof t!="string"&&Bt(s).includes(e)?s[e]=t:s.setAttribute(e,t))}function Ut(s){return s.__attributes??(s.__attributes={[Lt]:s.nodeName.includes("-"),[Rt]:s.namespaceURI===mt})}var Le=new Map;function Bt(s){var e=s.getAttribute("is")||s.nodeName,t=Le.get(e);if(t)return t;Le.set(e,t=[]);for(var n,i=s,l=Element.prototype;l!==i;){n=It(i);for(var a in n)n[a].set&&t.push(a);i=yt(i)}return t}function fe(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}const Re="exo-conversations";function Ft(s,e){var i,l,a,h,o,M,d;const t={},n=[];for(const v of s.nodes||[]){const C=e==null?void 0:e[v.nodeId],r={...v.nodeProfile??{},...C??{}},S=((l=(i=r==null?void 0:r.memory)==null?void 0:i.ramTotal)==null?void 0:l.inBytes)??0,m=((h=(a=r==null?void 0:r.memory)==null?void 0:a.ramAvailable)==null?void 0:h.inBytes)??0,c=Math.max(S-m,0),u=((r==null?void 0:r.networkInterfaces)||[]).map(y=>{const f=[];if(y.ipAddress&&typeof y.ipAddress=="string"&&f.push(y.ipAddress),Array.isArray(y.addresses))for(const w of y.addresses)typeof w=="string"?f.push(w):w&&typeof w=="object"&&w.address&&f.push(w.address);return Array.isArray(y.ipAddresses)&&f.push(...y.ipAddresses.filter(w=>typeof w=="string")),Array.isArray(y.ips)&&f.push(...y.ips.filter(w=>typeof w=="string")),y.ipv4&&typeof y.ipv4=="string"&&f.push(y.ipv4),y.ipv6&&typeof y.ipv6=="string"&&f.push(y.ipv6),{name:y.name,addresses:Array.from(new Set(f))}}),D={};for(const y of u)for(const f of y.addresses||[])D[f]=y.name??"";t[v.nodeId]={system_info:{model_id:(r==null?void 0:r.modelId)??"Unknown",chip:r==null?void 0:r.chipId,memory:S},network_interfaces:u,ip_to_interface:D,macmon_info:{memory:{ram_usage:c,ram_total:S},temp:((o=r==null?void 0:r.system)==null?void 0:o.temp)!==void 0?{gpu_temp_avg:r.system.temp}:void 0,gpu_usage:((M=r==null?void 0:r.system)==null?void 0:M.gpuUsage)!==void 0?[0,r.system.gpuUsage]:void 0,sys_power:(d=r==null?void 0:r.system)==null?void 0:d.sysPower},last_macmon_update:Date.now()/1e3,friendly_name:r==null?void 0:r.friendlyName}}for(const v of s.connections||[]){if(!v.localNodeId||!v.sendBackNodeId||v.localNodeId===v.sendBackNodeId||!t[v.localNodeId]||!t[v.sendBackNodeId])continue;let C;if(v.sendBackMultiaddr){const r=v.sendBackMultiaddr;typeof r=="string"?C=Me(r):C=r.ip_address||Me(r.multiaddr)||Me(r.address)}n.push({source:v.localNodeId,target:v.sendBackNodeId,sendBackIp:C})}return{nodes:t,edges:n}}function Me(s){if(!s)return;const e=s.split("/"),t=e.indexOf("ip4"),n=e.indexOf("ip6"),i=t>=0?t:n;if(i>=0&&e.length>i+1)return e[i+1]}var W,$,J,V,K,Y,q,G,X,Q,Z,ee,te,se,ne,ie,ae,re,oe,le,de;class jt{constructor(){T(this,W,_(H([])));T(this,$,_(null));T(this,J,_(!1));T(this,V,_(H([])));T(this,K,_(""));T(this,Y,_(!1));T(this,q,_(null));T(this,G,_(null));T(this,X,_(0));T(this,Q,_(null));T(this,Z,_(H({})));T(this,ee,_(H({})));T(this,te,_(H({})));T(this,se,_(H([])));T(this,ne,_(null));T(this,ie,_(!1));T(this,ae,_(null));T(this,re,_(!1));T(this,oe,_(!1));T(this,le,_(!1));ce(this,"fetchInterval",null);ce(this,"previewsInterval",null);ce(this,"lastConversationPersistTs",0);T(this,de,_(""));this.startPolling(),this.loadConversationsFromStorage(),this.loadDebugModeFromStorage()}get conversations(){return x(g(this,W))}set conversations(e){b(g(this,W),e,!0)}get activeConversationId(){return x(g(this,$))}set activeConversationId(e){b(g(this,$),e,!0)}get hasStartedChat(){return x(g(this,J))}set hasStartedChat(e){b(g(this,J),e,!0)}get messages(){return x(g(this,V))}set messages(e){b(g(this,V),e,!0)}get currentResponse(){return x(g(this,K))}set currentResponse(e){b(g(this,K),e,!0)}get isLoading(){return x(g(this,Y))}set isLoading(e){b(g(this,Y),e,!0)}get ttftMs(){return x(g(this,q))}set ttftMs(e){b(g(this,q),e,!0)}get tps(){return x(g(this,G))}set tps(e){b(g(this,G),e,!0)}get totalTokens(){return x(g(this,X))}set totalTokens(e){b(g(this,X),e,!0)}get topologyData(){return x(g(this,Q))}set topologyData(e){b(g(this,Q),e,!0)}get instances(){return x(g(this,Z))}set instances(e){b(g(this,Z),e,!0)}get runners(){return x(g(this,ee))}set runners(e){b(g(this,ee),e,!0)}get downloads(){return x(g(this,te))}set downloads(e){b(g(this,te),e,!0)}get placementPreviews(){return x(g(this,se))}set placementPreviews(e){b(g(this,se),e,!0)}get selectedPreviewModelId(){return x(g(this,ne))}set selectedPreviewModelId(e){b(g(this,ne),e,!0)}get isLoadingPreviews(){return x(g(this,ie))}set isLoadingPreviews(e){b(g(this,ie),e,!0)}get lastUpdate(){return x(g(this,ae))}set lastUpdate(e){b(g(this,ae),e,!0)}get isTopologyMinimized(){return x(g(this,re))}set isTopologyMinimized(e){b(g(this,re),e,!0)}get isSidebarOpen(){return x(g(this,oe))}set isSidebarOpen(e){b(g(this,oe),e,!0)}get debugMode(){return x(g(this,le))}set debugMode(e){b(g(this,le),e,!0)}loadConversationsFromStorage(){try{const e=localStorage.getItem(Re);if(e){const t=JSON.parse(e);this.conversations=t.map(n=>({id:n.id??fe(),name:n.name??"Chat",messages:n.messages??[],createdAt:n.createdAt??Date.now(),updatedAt:n.updatedAt??Date.now(),modelId:n.modelId??null,sharding:n.sharding??null,instanceType:n.instanceType??null}))}}catch(e){console.error("Failed to load conversations:",e)}}saveConversationsToStorage(){try{localStorage.setItem(Re,JSON.stringify(this.conversations))}catch(e){console.error("Failed to save conversations:",e)}}loadDebugModeFromStorage(){try{const e=localStorage.getItem("exo-debug-mode");e!==null&&(this.debugMode=e==="true")}catch(e){console.error("Failed to load debug mode:",e)}}saveDebugModeToStorage(){try{localStorage.setItem("exo-debug-mode",this.debugMode?"true":"false")}catch(e){console.error("Failed to save debug mode:",e)}}createConversation(e){const t=fe(),n=Date.now();let i=this.selectedChatModel||null,l=null,a=null;if(i){for(const[,o]of Object.entries(this.instances))if(this.extractInstanceModelId(o)===i){const d=this.describeInstance(o);l=d.instanceType,a=d.sharding;break}}else{const o=Object.values(this.instances)[0];if(o){i=this.extractInstanceModelId(o)??null;const d=this.describeInstance(o);l=d.instanceType,a=d.sharding}}const h={id:t,name:e||`Chat ${new Date(n).toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}`,messages:[],createdAt:n,updatedAt:n,modelId:i,sharding:a,instanceType:l};return this.conversations.unshift(h),this.activeConversationId=t,this.messages=[],this.hasStartedChat=!0,this.isTopologyMinimized=!0,this.isSidebarOpen=!0,this.saveConversationsToStorage(),t}loadConversation(e){const t=this.conversations.find(n=>n.id===e);return t?(this.activeConversationId=e,this.messages=[...t.messages],this.hasStartedChat=!0,this.isTopologyMinimized=!0,this.isSidebarOpen=!0,this.refreshConversationModelFromInstances(),!0):!1}deleteConversation(e){this.conversations=this.conversations.filter(t=>t.id!==e),this.activeConversationId===e&&(this.activeConversationId=null,this.messages=[],this.hasStartedChat=!1,this.isTopologyMinimized=!1),this.saveConversationsToStorage()}deleteAllConversations(){this.conversations=[],this.activeConversationId=null,this.messages=[],this.hasStartedChat=!1,this.isTopologyMinimized=!1,this.saveConversationsToStorage()}renameConversation(e,t){const n=this.conversations.find(i=>i.id===e);n&&(n.name=t,n.updatedAt=Date.now(),this.saveConversationsToStorage())}getTaggedValue(e){if(!e||typeof e!="object")return[null,null];const t=Object.keys(e);return t.length===1?[t[0],e[t[0]]]:[null,null]}extractInstanceModelId(e){var i;const[,t]=this.getTaggedValue(e);return!t||typeof t!="object"?null:((i=t.shardAssignments)==null?void 0:i.modelId)??null}describeInstance(e){var M;const[t,n]=this.getTaggedValue(e);if(!n||typeof n!="object")return{sharding:null,instanceType:null};let i=null;t==="MlxRingInstance"?i="MLX Ring":(t==="MlxIbvInstance"||t==="MlxJacclInstance")&&(i="MLX RDMA");let l=null;const h=((M=n.shardAssignments)==null?void 0:M.runnerToShard)||{},o=Object.values(h)[0];if(o){const[d]=this.getTaggedValue(o);d==="PipelineShardMetadata"?l="Pipeline":d==="TensorShardMetadata"?l="Tensor":d==="PrefillDecodeShardMetadata"&&(l="Prefill/Decode")}return{sharding:l,instanceType:i}}buildConversationModelInfo(e){let t=null,n=null;for(const[,i]of Object.entries(this.instances))if(this.extractInstanceModelId(i)===e){const a=this.describeInstance(i);t=a.sharding,n=a.instanceType;break}return{modelId:e,sharding:t,instanceType:n}}applyConversationModelInfo(e){if(!this.activeConversationId)return;const t=this.conversations.find(n=>n.id===this.activeConversationId);t&&(t.modelId||(t.modelId=e.modelId),t.sharding=e.sharding,t.instanceType=e.instanceType,this.saveConversationsToStorage())}getModelTail(e){const t=e.split("/");return(t[t.length-1]||e).toLowerCase()}isBetterModelId(e,t){if(!t)return!1;if(!e)return!0;const n=this.getModelTail(e),i=this.getModelTail(t);return i.length>n.length&&i.startsWith(n)}refreshConversationModelFromInstances(){if(!this.activeConversationId)return;const e=this.conversations.find(a=>a.id===this.activeConversationId);if(!e)return;let t=e.modelId;if(!t&&this.selectedChatModel&&(t=this.selectedChatModel),!t){const a=Object.values(this.instances)[0];a&&(t=this.extractInstanceModelId(a))}if(!t)return;let n=t;for(const[,a]of Object.entries(this.instances)){const h=this.extractInstanceModelId(a);if(h){if(h===n)break;this.isBetterModelId(n,h)&&(n=h)}}this.isBetterModelId(e.modelId,n)&&(e.modelId=n);const i=this.buildConversationModelInfo(n);!!(i.sharding||i.instanceType||!e.modelId)&&this.applyConversationModelInfo(i)}getDebugMode(){return this.debugMode}updateActiveConversation(){if(!this.activeConversationId)return;const e=this.conversations.find(t=>t.id===this.activeConversationId);if(e){if(e.messages=[...this.messages],e.updatedAt=Date.now(),e.name.startsWith("Chat ")){const t=e.messages.find(n=>n.role==="user"&&n.content.trim());if(t){let n=t.content.replace(/\[File:.*?\][\s\S]*?```[\s\S]*?```/g,"").trim();if(n){const i=n.slice(0,50);e.name=i.length<n.length?i+"...":i}}}this.saveConversationsToStorage()}}persistActiveConversation(e=400){const t=Date.now();t-this.lastConversationPersistTs<e||(this.lastConversationPersistTs=t,this.updateActiveConversation())}toggleSidebar(){this.isSidebarOpen=!this.isSidebarOpen}setDebugMode(e){this.debugMode=e,this.saveDebugModeToStorage()}toggleDebugMode(){this.debugMode=!this.debugMode,this.saveDebugModeToStorage()}startPolling(){this.fetchState(),this.fetchInterval=setInterval(()=>this.fetchState(),1e3)}stopPolling(){this.fetchInterval&&(clearInterval(this.fetchInterval),this.fetchInterval=null),this.stopPreviewsPolling()}async fetchState(){try{const e=await fetch("/state");if(!e.ok)throw new Error(`Failed to fetch state: ${e.status}`);const t=await e.json();t.topology&&(this.topologyData=Ft(t.topology,t.nodeProfiles)),t.instances&&(this.instances=t.instances,this.refreshConversationModelFromInstances()),t.runners&&(this.runners=t.runners),t.downloads&&(this.downloads=t.downloads),this.lastUpdate=Date.now()}catch(e){console.error("Error fetching state:",e)}}async fetchPlacementPreviews(e,t=!0){if(e){t&&(this.isLoadingPreviews=!0),this.selectedPreviewModelId=e;try{const n=await fetch(`/instance/previews?model_id=${encodeURIComponent(e)}`);if(!n.ok)throw new Error(`Failed to fetch placement previews: ${n.status}`);const i=await n.json();this.placementPreviews=i.previews}catch(n){console.error("Error fetching placement previews:",n),this.placementPreviews=[]}finally{t&&(this.isLoadingPreviews=!1)}}}startPreviewsPolling(e){this.stopPreviewsPolling(),this.fetchPlacementPreviews(e),this.previewsInterval=setInterval(()=>{this.selectedPreviewModelId&&this.fetchPlacementPreviews(this.selectedPreviewModelId,!1)},15e3)}stopPreviewsPolling(){this.previewsInterval&&(clearInterval(this.previewsInterval),this.previewsInterval=null)}selectPreviewModel(e){e?this.startPreviewsPolling(e):(this.stopPreviewsPolling(),this.selectedPreviewModelId=null,this.placementPreviews=[])}startChat(){this.activeConversationId?(this.hasStartedChat=!0,this.isSidebarOpen=!0,setTimeout(()=>{this.isTopologyMinimized=!0},100)):this.createConversation()}addMessage(e,t){const n={id:fe(),role:e,content:t,timestamp:Date.now()};return this.messages.push(n),n}deleteMessage(e){const t=this.messages.findIndex(n=>n.id===e);t!==-1&&(this.messages=this.messages.slice(0,t),this.updateActiveConversation())}editMessage(e,t){const n=this.messages.find(i=>i.id===e);n&&(n.content=t,n.timestamp=Date.now(),this.updateActiveConversation())}async editAndRegenerate(e,t){const n=this.messages.findIndex(l=>l.id===e);if(n===-1)return;const i=this.messages[n];i.role==="user"&&(i.content=t,i.timestamp=Date.now(),this.messages=this.messages.slice(0,n+1),await this.regenerateLastResponse())}async regenerateLastResponse(){var n,i,l,a,h;if(this.isLoading)return;let e=-1;for(let o=this.messages.length-1;o>=0;o--)if(this.messages[o].role==="user"){e=o;break}if(e===-1)return;this.messages[e],this.messages=this.messages.slice(0,e+1),this.isLoading=!0,this.currentResponse="";const t=this.addMessage("assistant","");try{const M=[{role:"system",content:"You are a helpful AI assistant. Respond directly and concisely. Do not show your reasoning or thought process."},...this.messages.slice(0,-1).map(u=>({role:u.role,content:u.content}))];let d=this.selectedChatModel;if(!d){const u=Object.keys(this.instances)[0];if(u){const D=this.instances[u];if(D){const y=Object.keys(D);if(y.length===1){const f=D[y[0]];d=((n=f==null?void 0:f.shardAssignments)==null?void 0:n.modelId)||""}}}}if(!d){t.content="Error: No model available. Please launch an instance first.",this.isLoading=!1,this.updateActiveConversation();return}const v=await fetch("/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:d,messages:M,stream:!0})});if(!v.ok){const u=await v.text();t.content=`Error: ${v.status} - ${u}`,this.isLoading=!1,this.updateActiveConversation();return}const C=(i=v.body)==null?void 0:i.getReader();if(!C){t.content="Error: No response stream available",this.isLoading=!1,this.updateActiveConversation();return}const r=new TextDecoder;let S="",m="";for(;;){const{done:u,value:D}=await C.read();if(u)break;const y=r.decode(D,{stream:!0}),f=(m+y).split(`
`);m=f.pop()||"";for(const w of f){const E=w.trim();if(!(!E||E==="data: [DONE]")&&E.startsWith("data: "))try{const N=(h=(a=(l=JSON.parse(E.slice(6)).choices)==null?void 0:l[0])==null?void 0:a.delta)==null?void 0:h.content;if(N){S+=N;const{displayContent:P}=this.stripThinkingTags(S);this.currentResponse=P,t.content=P}}catch{}}}const{displayContent:c}=this.stripThinkingTags(S);t.content=c,this.currentResponse="",this.updateActiveConversation()}catch(o){t.content=`Error: ${o instanceof Error?o.message:"Unknown error"}`,this.updateActiveConversation()}finally{this.isLoading=!1}}get selectedChatModel(){return x(g(this,de))}set selectedChatModel(e){b(g(this,de),e,!0)}setSelectedModel(e){this.selectedChatModel=e,this.ttftMs=null,this.tps=null}stripThinkingTags(e){var h;const t=[];let n=e;const i=/<think>([\s\S]*?)<\/think>/gi;let l;for(;(l=i.exec(e))!==null;){const o=(h=l[1])==null?void 0:h.trim();o&&t.push(o)}n=n.replace(i,"");const a=n.lastIndexOf("<think>");if(a!==-1){const o=n.slice(a+7).trim();o&&t.push(o),n=n.slice(0,a)}return{displayContent:n.trim(),thinkingContent:t.join(`

`)}}async sendMessage(e,t){var h,o,M,d,v,C,r,S;if(!e.trim()&&(!t||t.length===0)||this.isLoading)return;this.hasStartedChat||this.startChat(),this.isLoading=!0,this.currentResponse="",this.ttftMs=null,this.tps=null,this.totalTokens=0;const n=[];let i="";if(t&&t.length>0)for(const m of t)m.type.startsWith("image/")&&m.preview?n.push({type:"image",name:m.name,preview:m.preview,mimeType:m.type}):m.textContent?(n.push({type:"text",name:m.name,content:m.textContent,mimeType:m.type}),i+=`

[File: ${m.name}]
\`\`\`
${m.textContent}
\`\`\``):n.push({type:"file",name:m.name,mimeType:m.type});const l={id:fe(),role:"user",content:e,timestamp:Date.now(),attachments:n.length>0?n:void 0};this.messages.push(l);const a=this.addMessage("assistant","");this.updateActiveConversation();try{const c=[{role:"system",content:"You are a helpful AI assistant. Respond directly and concisely. Do not show your reasoning or thought process. When files are shared with you, analyze them and respond helpfully."},...this.messages.slice(0,-1).map(p=>{let A=p.content;if(p.attachments)for(const k of p.attachments)k.type==="text"&&k.content&&(A+=`

[File: ${k.name}]
\`\`\`
${k.content}
\`\`\``);return{role:p.role,content:A}})];let u=this.selectedChatModel;if(!u){for(const[,p]of Object.entries(this.instances))if(p&&typeof p=="object"){const A=Object.keys(p);if(A.length===1){const k=p[A[0]];if((h=k==null?void 0:k.shardAssignments)!=null&&h.modelId){u=k.shardAssignments.modelId;break}}}}if(!u)throw new Error("No model selected and no running instances available. Please launch an instance first.");const D=this.buildConversationModelInfo(u);this.applyConversationModelInfo(D);const y=performance.now();let f=null,w=0;const E=await fetch("/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:u,messages:c,temperature:.7,stream:!0})});if(!E.ok){const p=await E.text();throw new Error(`API error: ${E.status} - ${p}`)}const F=(o=E.body)==null?void 0:o.getReader();if(!F)throw new Error("No response body");const N=new TextDecoder;let P="",B="";for(;;){const{done:p,value:A}=await F.read();if(p)break;B+=N.decode(A,{stream:!0});const k=B.split(`
`);B=k.pop()||"";for(const ue of k){const z=ue.trim();if(z&&z.startsWith("data: ")){const Te=z.slice(6);if(Te==="[DONE]")continue;try{const _e=(v=(d=(M=JSON.parse(Te).choices)==null?void 0:M[0])==null?void 0:d.delta)==null?void 0:v.content;if(_e){if(f===null&&(f=performance.now(),this.ttftMs=f-y),w+=1,this.totalTokens=w,f!==null&&w>1){const pe=performance.now()-f;this.tps=w/pe*1e3}P+=_e;const{displayContent:be,thinkingContent:Je}=this.stripThinkingTags(P);this.currentResponse=be;const ge=this.messages.findIndex(pe=>pe.id===a.id);ge!==-1&&(this.messages[ge].content=be,this.messages[ge].thinking=Je||void 0),this.persistActiveConversation()}}catch{}}}}if(B.trim()){const p=B.trim();if(p.startsWith("data: ")&&p.slice(6)!=="[DONE]")try{const k=(S=(r=(C=JSON.parse(p.slice(6)).choices)==null?void 0:C[0])==null?void 0:r.delta)==null?void 0:S.content;k&&(P+=k,this.persistActiveConversation())}catch{}}if(f!==null&&w>1){const p=performance.now()-f;this.tps=w/p*1e3}const{displayContent:L,thinkingContent:j}=this.stripThinkingTags(P),O=this.messages.findIndex(p=>p.id===a.id);O!==-1&&(this.messages[O].content=L,this.messages[O].thinking=j||void 0,this.ttftMs!==null&&(this.messages[O].ttftMs=this.ttftMs),this.tps!==null&&(this.messages[O].tps=this.tps)),this.persistActiveConversation()}catch(m){console.error("Error sending message:",m);const c=this.messages.findIndex(u=>u.id===a.id);c!==-1&&(this.messages[c].content=`Error: ${m instanceof Error?m.message:"Failed to get response"}`),this.persistActiveConversation()}finally{this.isLoading=!1,this.currentResponse="",this.updateActiveConversation()}}clearChat(){this.activeConversationId=null,this.messages=[],this.hasStartedChat=!1,this.isTopologyMinimized=!1,this.currentResponse="",this.ttftMs=null,this.tps=null}getActiveConversation(){return this.activeConversationId&&this.conversations.find(e=>e.id===this.activeConversationId)||null}}W=new WeakMap,$=new WeakMap,J=new WeakMap,V=new WeakMap,K=new WeakMap,Y=new WeakMap,q=new WeakMap,G=new WeakMap,X=new WeakMap,Q=new WeakMap,Z=new WeakMap,ee=new WeakMap,te=new WeakMap,se=new WeakMap,ne=new WeakMap,ie=new WeakMap,ae=new WeakMap,re=new WeakMap,oe=new WeakMap,le=new WeakMap,de=new WeakMap;const I=new jt,ts=()=>I.hasStartedChat,ss=()=>I.messages,ns=()=>I.currentResponse,is=()=>I.isLoading,as=()=>I.ttftMs,rs=()=>I.tps,os=()=>I.topologyData,ls=()=>I.instances,ds=()=>I.runners,cs=()=>I.downloads,hs=()=>I.placementPreviews,fs=()=>I.selectedPreviewModelId,us=()=>I.isLoadingPreviews,gs=()=>I.lastUpdate,ps=()=>I.isTopologyMinimized,vs=()=>I.selectedChatModel,ms=()=>I.getDebugMode(),ys=(s,e)=>I.sendMessage(s,e),Is=()=>I.clearChat(),Ms=s=>I.setSelectedModel(s),Cs=s=>I.selectPreviewModel(s),ws=s=>I.deleteMessage(s),xs=(s,e)=>I.editAndRegenerate(s,e),Ts=()=>I.regenerateLastResponse(),_s=()=>I.conversations,bs=()=>I.activeConversationId,Ss=s=>I.createConversation(s),As=s=>I.loadConversation(s),ks=s=>I.deleteConversation(s),Ps=()=>I.deleteAllConversations(),Ds=(s,e)=>I.renameConversation(s,e),Es=()=>I.toggleDebugMode(),Ns=()=>I.fetchState();var Ht=We('<button class="text-sm text-exo-light-gray hover:text-exo-yellow transition-colors tracking-wider uppercase flex items-center gap-2 cursor-pointer" title="Back to topology view"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg> Home</button>'),zt=We('<header class="relative z-20 flex items-center justify-center px-6 pt-8 pb-4 bg-exo-dark-gray"><button><img src="/exo-logo.png" alt="EXO" class="h-18 drop-shadow-[0_0_20px_rgba(255,215,0,0.5)]"/></button> <div class="absolute right-6 top-1/2 -translate-y-1/2 flex items-center gap-4"><!> <a href="/#/downloads" class="text-sm text-exo-light-gray hover:text-exo-yellow transition-colors tracking-wider uppercase flex items-center gap-2 cursor-pointer" title="View downloads overview"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"></path><path d="M7 12l5 5 5-5"></path><path d="M5 21h14"></path></svg> Downloads</a></div></header>');function Os(s,e){Mt(e,!1);let t=Oe(e,"showHome",8,!0),n=Oe(e,"onHome",8,null);function i(){if(n()){n()();return}window.location.hash="/"}_t();var l=zt(),a=De(l);a.__click=i;var h=xt(a,2),o=De(h);{var M=d=>{var v=Ht();v.__click=i,Ne(d,v)};St(o,d=>{t()&&d(M)})}Tt(2),Ee(h),Ee(l),Ct(()=>{Ot(a,1,`hover:opacity-80 transition-opacity ${t()?"cursor-pointer":"cursor-default"}`),xe(a,"title",t()?"Go to home":""),a.disabled=!t()}),Ne(s,l),wt()}bt(["click"]);export{es as A,_s as B,Ps as C,Ds as D,ks as E,As as F,bs as G,Os as H,fs as I,hs as J,Is as K,ts as L,Cs as M,us as N,ds as O,xe as a,Zt as b,Qt as c,cs as d,Xt as e,ps as f,ms as g,Ms as h,Gt as i,is as j,vs as k,gs as l,ys as m,ls as n,as as o,rs as p,ss as q,Ns as r,Ot as s,os as t,ns as u,ws as v,xs as w,Ts as x,Es as y,Ss as z};
